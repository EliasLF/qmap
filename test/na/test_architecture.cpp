//
// This file is part of the MQT QMAP library released under the MIT license.
// See README.md or go to https://github.com/cda-tum/qmap for more information.
//

#include "Architecture.hpp"
#include "operations/OpType.hpp"

#include "gtest/gtest.h"
#include <fstream>
#include <random>
#include <sstream>
#include <string>

constexpr const char* ARCH_FN = "arch.json";
constexpr const char* GRID_FN = "grid.csv";

class TestNAArchitecture : public testing::Test {
protected:
  void SetUp() override {
    // write content to a file
    std::ofstream archF(ARCH_FN);
    archF << "{\n"
             "  \"name\": \"Test\",\n"
             "  \"operations\": [\n"
             "    {\n"
             "      \"name\": \"rz\",\n"
             "      \"type\": \"local\",\n"
             "      \"zones\": [\"storage\", \"readout\"],\n"
             "      \"time\": 0.5,\n"
             "      \"fidelity\": 0.999\n"
             "    },\n"
             "    {\n"
             "      \"name\": \"ry\",\n"
             "      \"type\": \"global\",\n"
             "      \"zones\": [\"storage\", \"readout\"],\n"
             "      \"time\": 0.5,\n"
             "      \"fidelity\": 0.999\n"
             "    },\n"
             "    {\n"
             "      \"name\": \"cz\",\n"
             "      \"type\": \"global\",\n"
             "      \"zones\": [\"entangling\"],\n"
             "      \"time\": 0.2,\n"
             "      \"fidelity\": 0.9959\n"
             "    },\n"
             "    {\n"
             "      \"name\": \"measure\",\n"
             "      \"type\": \"global\",\n"
             "      \"zones\": [\"readout\"],\n"
             "      \"time\": 0.2,\n"
             "      \"fidelity\": 0.95\n"
             "    }\n"
             "  ],\n"
             "  \"decoherence\": {\n"
             "    \"t1\": 100000000,\n"
             "    \"t2\": 1500000\n"
             "  },\n"
             "  \"interactionRadius\": 3,\n"
             "  \"minAtomDistance\": 0.1,\n"
             "  \"AOD\": {\n"
             "    \"number\": 1,\n"
             "    \"rows\": 5,\n"
             "    \"columns\": 5,\n"
             "    \"move\": {\n"
             "      \"speed\": 0.55,\n"
             "      \"fidelity\": 1\n"
             "    },\n"
             "    \"activate\": {\n"
             "      \"time\": 20,\n"
             "      \"fidelity\": 1\n"
             "    },\n"
             "    \"deactivate\": {\n"
             "      \"time\": 20,\n"
             "      \"fidelity\": 1\n"
             "    }\n"
             "  }\n"
             "}\n"
             "\n";
    archF.close();
    std::ofstream gridF(GRID_FN);
    gridF << "address,x,y,zone,type\n"
             "0,2,0,entangling,SLM\n"
             "1,4,0,entangling,AOD\n"
             "2,14,0,entangling,SLM\n"
             "3,16,0,entangling,AOD\n"
             "4,26,0,entangling,SLM\n"
             "5,28,0,entangling,AOD\n"
             "6,38,0,entangling,SLM\n"
             "7,40,0,entangling,AOD\n"
             "8,50,0,entangling,SLM\n"
             "9,52,0,entangling,AOD\n"
             "10,62,0,entangling,SLM\n"
             "11,64,0,entangling,AOD\n"
             "12,74,0,entangling,SLM\n"
             "13,76,0,entangling,AOD\n"
             "14,86,0,entangling,SLM\n"
             "15,88,0,entangling,AOD\n"
             "16,98,0,entangling,SLM\n"
             "17,100,0,entangling,AOD\n"
             "18,110,0,entangling,SLM\n"
             "19,112,0,entangling,AOD\n"
             "20,2,6,entangling,SLM\n"
             "21,4,6,entangling,AOD\n"
             "22,14,6,entangling,SLM\n"
             "23,16,6,entangling,AOD\n"
             "24,26,6,entangling,SLM\n"
             "25,28,6,entangling,AOD\n"
             "26,38,6,entangling,SLM\n"
             "27,40,6,entangling,AOD\n"
             "28,50,6,entangling,SLM\n"
             "29,52,6,entangling,AOD\n"
             "30,62,6,entangling,SLM\n"
             "31,64,6,entangling,AOD\n"
             "32,74,6,entangling,SLM\n"
             "33,76,6,entangling,AOD\n"
             "34,86,6,entangling,SLM\n"
             "35,88,6,entangling,AOD\n"
             "36,98,6,entangling,SLM\n"
             "37,100,6,entangling,AOD\n"
             "38,110,6,entangling,SLM\n"
             "39,112,6,entangling,AOD\n"
             "40,2,12,entangling,SLM\n"
             "41,4,12,entangling,AOD\n"
             "42,14,12,entangling,SLM\n"
             "43,16,12,entangling,AOD\n"
             "44,26,12,entangling,SLM\n"
             "45,28,12,entangling,AOD\n"
             "46,38,12,entangling,SLM\n"
             "47,40,12,entangling,AOD\n"
             "48,50,12,entangling,SLM\n"
             "49,52,12,entangling,AOD\n"
             "50,62,12,entangling,SLM\n"
             "51,64,12,entangling,AOD\n"
             "52,74,12,entangling,SLM\n"
             "53,76,12,entangling,AOD\n"
             "54,86,12,entangling,SLM\n"
             "55,88,12,entangling,AOD\n"
             "56,98,12,entangling,SLM\n"
             "57,100,12,entangling,AOD\n"
             "58,110,12,entangling,SLM\n"
             "59,112,12,entangling,AOD\n"
             "60,2,18,entangling,SLM\n"
             "61,4,18,entangling,AOD\n"
             "62,14,18,entangling,SLM\n"
             "63,16,18,entangling,AOD\n"
             "64,26,18,entangling,SLM\n"
             "65,28,18,entangling,AOD\n"
             "66,38,18,entangling,SLM\n"
             "67,40,18,entangling,AOD\n"
             "68,50,18,entangling,SLM\n"
             "69,52,18,entangling,AOD\n"
             "70,62,18,entangling,SLM\n"
             "71,64,18,entangling,AOD\n"
             "72,74,18,entangling,SLM\n"
             "73,76,18,entangling,AOD\n"
             "74,86,18,entangling,SLM\n"
             "75,88,18,entangling,AOD\n"
             "76,98,18,entangling,SLM\n"
             "77,100,18,entangling,AOD\n"
             "78,110,18,entangling,SLM\n"
             "79,112,18,entangling,AOD\n"
             "80,0,44,storage,SLM\n"
             "81,6,44,storage,SLM\n"
             "82,12,44,storage,SLM\n"
             "83,18,44,storage,SLM\n"
             "84,24,44,storage,SLM\n"
             "85,30,44,storage,SLM\n"
             "86,36,44,storage,SLM\n"
             "87,42,44,storage,SLM\n"
             "88,48,44,storage,SLM\n"
             "89,54,44,storage,SLM\n"
             "90,60,44,storage,SLM\n"
             "91,66,44,storage,SLM\n"
             "92,72,44,storage,SLM\n"
             "93,78,44,storage,SLM\n"
             "94,84,44,storage,SLM\n"
             "95,90,44,storage,SLM\n"
             "96,96,44,storage,SLM\n"
             "97,102,44,storage,SLM\n"
             "98,108,44,storage,SLM\n"
             "99,114,44,storage,SLM\n"
             "100,0,50,storage,SLM\n"
             "101,6,50,storage,SLM\n"
             "102,12,50,storage,SLM\n"
             "103,18,50,storage,SLM\n"
             "104,24,50,storage,SLM\n"
             "105,30,50,storage,SLM\n"
             "106,36,50,storage,SLM\n"
             "107,42,50,storage,SLM\n"
             "108,48,50,storage,SLM\n"
             "109,54,50,storage,SLM\n"
             "110,60,50,storage,SLM\n"
             "111,66,50,storage,SLM\n"
             "112,72,50,storage,SLM\n"
             "113,78,50,storage,SLM\n"
             "114,84,50,storage,SLM\n"
             "115,90,50,storage,SLM\n"
             "116,96,50,storage,SLM\n"
             "117,102,50,storage,SLM\n"
             "118,108,50,storage,SLM\n"
             "119,114,50,storage,SLM\n"
             "120,0,56,storage,SLM\n"
             "121,6,56,storage,SLM\n"
             "122,12,56,storage,SLM\n"
             "123,18,56,storage,SLM\n"
             "124,24,56,storage,SLM\n"
             "125,30,56,storage,SLM\n"
             "126,36,56,storage,SLM\n"
             "127,42,56,storage,SLM\n"
             "128,48,56,storage,SLM\n"
             "129,54,56,storage,SLM\n"
             "130,60,56,storage,SLM\n"
             "131,66,56,storage,SLM\n"
             "132,72,56,storage,SLM\n"
             "133,78,56,storage,SLM\n"
             "134,84,56,storage,SLM\n"
             "135,90,56,storage,SLM\n"
             "136,96,56,storage,SLM\n"
             "137,102,56,storage,SLM\n"
             "138,108,56,storage,SLM\n"
             "139,114,56,storage,SLM\n"
             "140,0,62,storage,SLM\n"
             "141,6,62,storage,SLM\n"
             "142,12,62,storage,SLM\n"
             "143,18,62,storage,SLM\n"
             "144,24,62,storage,SLM\n"
             "145,30,62,storage,SLM\n"
             "146,36,62,storage,SLM\n"
             "147,42,62,storage,SLM\n"
             "148,48,62,storage,SLM\n"
             "149,54,62,storage,SLM\n"
             "150,60,62,storage,SLM\n"
             "151,66,62,storage,SLM\n"
             "152,72,62,storage,SLM\n"
             "153,78,62,storage,SLM\n"
             "154,84,62,storage,SLM\n"
             "155,90,62,storage,SLM\n"
             "156,96,62,storage,SLM\n"
             "157,102,62,storage,SLM\n"
             "158,108,62,storage,SLM\n"
             "159,114,62,storage,SLM\n"
             "160,0,68,storage,SLM\n"
             "161,6,68,storage,SLM\n"
             "162,12,68,storage,SLM\n"
             "163,18,68,storage,SLM\n"
             "164,24,68,storage,SLM\n"
             "165,30,68,storage,SLM\n"
             "166,36,68,storage,SLM\n"
             "167,42,68,storage,SLM\n"
             "168,48,68,storage,SLM\n"
             "169,54,68,storage,SLM\n"
             "170,60,68,storage,SLM\n"
             "171,66,68,storage,SLM\n"
             "172,72,68,storage,SLM\n"
             "173,78,68,storage,SLM\n"
             "174,84,68,storage,SLM\n"
             "175,90,68,storage,SLM\n"
             "176,96,68,storage,SLM\n"
             "177,102,68,storage,SLM\n"
             "178,108,68,storage,SLM\n"
             "179,114,68,storage,SLM\n"
             "180,0,74,storage,SLM\n"
             "181,6,74,storage,SLM\n"
             "182,12,74,storage,SLM\n"
             "183,18,74,storage,SLM\n"
             "184,24,74,storage,SLM\n"
             "185,30,74,storage,SLM\n"
             "186,36,74,storage,SLM\n"
             "187,42,74,storage,SLM\n"
             "188,48,74,storage,SLM\n"
             "189,54,74,storage,SLM\n"
             "190,60,74,storage,SLM\n"
             "191,66,74,storage,SLM\n"
             "192,72,74,storage,SLM\n"
             "193,78,74,storage,SLM\n"
             "194,84,74,storage,SLM\n"
             "195,90,74,storage,SLM\n"
             "196,96,74,storage,SLM\n"
             "197,102,74,storage,SLM\n"
             "198,108,74,storage,SLM\n"
             "199,114,74,storage,SLM\n"
             "200,0,80,storage,SLM\n"
             "201,6,80,storage,SLM\n"
             "202,12,80,storage,SLM\n"
             "203,18,80,storage,SLM\n"
             "204,24,80,storage,SLM\n"
             "205,30,80,storage,SLM\n"
             "206,36,80,storage,SLM\n"
             "207,42,80,storage,SLM\n"
             "208,48,80,storage,SLM\n"
             "209,54,80,storage,SLM\n"
             "210,60,80,storage,SLM\n"
             "211,66,80,storage,SLM\n"
             "212,72,80,storage,SLM\n"
             "213,78,80,storage,SLM\n"
             "214,84,80,storage,SLM\n"
             "215,90,80,storage,SLM\n"
             "216,96,80,storage,SLM\n"
             "217,102,80,storage,SLM\n"
             "218,108,80,storage,SLM\n"
             "219,114,80,storage,SLM\n"
             "220,0,86,storage,SLM\n"
             "221,6,86,storage,SLM\n"
             "222,12,86,storage,SLM\n"
             "223,18,86,storage,SLM\n"
             "224,24,86,storage,SLM\n"
             "225,30,86,storage,SLM\n"
             "226,36,86,storage,SLM\n"
             "227,42,86,storage,SLM\n"
             "228,48,86,storage,SLM\n"
             "229,54,86,storage,SLM\n"
             "230,60,86,storage,SLM\n"
             "231,66,86,storage,SLM\n"
             "232,72,86,storage,SLM\n"
             "233,78,86,storage,SLM\n"
             "234,84,86,storage,SLM\n"
             "235,90,86,storage,SLM\n"
             "236,96,86,storage,SLM\n"
             "237,102,86,storage,SLM\n"
             "238,108,86,storage,SLM\n"
             "239,114,86,storage,SLM\n"
             "240,0,92,readout,SLM\n"
             "241,6,92,readout,SLM\n"
             "242,12,92,readout,SLM\n"
             "243,18,92,readout,SLM\n"
             "244,24,92,readout,SLM\n"
             "245,30,92,readout,SLM\n"
             "246,36,92,readout,SLM\n"
             "247,42,92,readout,SLM\n"
             "248,48,92,readout,SLM\n"
             "249,54,92,readout,SLM\n"
             "250,60,92,readout,SLM\n"
             "251,66,92,readout,SLM\n"
             "252,72,92,readout,SLM\n"
             "253,78,92,readout,SLM\n"
             "254,84,92,readout,SLM\n"
             "255,90,92,readout,SLM\n"
             "256,96,92,readout,SLM\n"
             "257,102,92,readout,SLM\n"
             "258,108,92,readout,SLM\n"
             "259,114,92,readout,SLM\n"
             "\n";
    gridF.close();
  }
  void TearDown() override {
    std::remove(ARCH_FN);
    std::remove(GRID_FN);
  }
};

TEST_F(TestNAArchitecture, Import) {
  na::Architecture const arch(ARCH_FN, GRID_FN);

  EXPECT_EQ(arch.getNZones(), 3);
  EXPECT_EQ(arch.getNSites(), 260);
  EXPECT_EQ(arch.getName(), "Test");
  EXPECT_EQ(arch.getZoneLabel(arch.getZone(0)), "entangling");
}

TEST_F(TestNAArchitecture, GateApplicability) {
  na::Architecture const arch(ARCH_FN, GRID_FN);

  EXPECT_TRUE(arch.isAllowedGlobally(qc::OpType::RY, 1, 0));
  EXPECT_TRUE(arch.isAllowedGlobally(qc::OpType::Z, 0, 1));
  EXPECT_TRUE(arch.isAllowedLocally(qc::OpType::RZ, 1, 0));
}
